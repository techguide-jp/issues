name: Notify Slack on Issue Status Change

on:
  issues:
    types: [edited]

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Check jq installation
        run: jq --version

      - name: Debug GitHub Event
        env:
          GITHUB_EVENT_JSON: ${{ toJson(github.event) }}
        run: echo "ã‚¤ãƒ™ãƒ³ãƒˆãƒ†ã‚¹ãƒˆï¼š$GITHUB_EVENT_JSON"

      - name: Extract status and send Slack notification
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_MF_FEED_ISSUE_WEBHOOK_URL }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          NOTIFY_USERS: "<@U0185TBQBP0>"
          GITHUB_EVENT_JSON: ${{ toJson(github.event) }}
        run: |
          # 1) æ–°ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’å–å¾—
          STATUS=$(echo "$GITHUB_EVENT_JSON" | jq -r '.changes.field_value.to')
          
          # 2) Issue æƒ…å ±ã‚’å–å¾—ã™ã‚‹
          # projects_v2_item.content_node_id ã‚’å–å¾—
          CONTENT_NODE_ID=$(echo "$GITHUB_EVENT_JSON" | jq -r '.projects_v2_item.content_node_id')
          
          # GraphQL ã§ Issue ã‚¿ã‚¤ãƒˆãƒ«ã¨URLã‚’å–å¾—ã™ã‚‹ä¾‹(ç°¡æ˜“)
          ISSUE_DATA=$(curl -s \
            -H "Authorization: bearer $GITHUB_TOKEN" \
            -X POST \
            -d '{"query":"query($id:ID!){ node(id:$id){ ... on Issue{ title url }}}","variables":{"id":"'"${CONTENT_NODE_ID}"'"}}' \
            https://api.github.com/graphql)

          ISSUE_TITLE=$(echo "$ISSUE_DATA" | jq -r '.data.node.title')
          ISSUE_URL=$(echo "$ISSUE_DATA"   | jq -r '.data.node.url')

          echo "æ–°ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: $STATUS"
          echo "Issue Title: $ISSUE_TITLE"
          echo "Issue URL: $ISSUE_URL"

          # 3) ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã«å¿œã˜ã¦Slack é€šçŸ¥
          if [ "$STATUS" == "é–‹ç™ºå¾…ã¡(Frontend)" ]; then
            echo "é–‹ç™ºå¾…ã¡(Frontend) ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ"
            curl -X POST -H 'Content-type: application/json' --data '{
              "text": "Issue status changed to *é–‹ç™ºå¾…ã¡(Frontend)* : '"${NOTIFY_USERS}"' æ¬¡ã®ãƒ•ãƒ­ãƒ³ãƒˆé–‹ç™ºæº–å‚™OKğŸ‘ \n*Issue Title:* <'"$ISSUE_URL"'|'"$ISSUE_TITLE"'>",
              "icon_emoji": ":rocket:"
            }' $SLACK_WEBHOOK_URL
          elif [ "$STATUS" == "QAä¸­" ]; then
            echo "QAä¸­ ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ"
            curl -X POST -H 'Content-type: application/json' --data '{
              "text": "Issue status changed to *ãƒ†ã‚¹ãƒˆä¸­* : '"${NOTIFY_USERS}"' ãƒ†ã‚¹ãƒˆã‚’é–‹å§‹ã—ã¦ãã ã•ã„ğŸƒâ€â™‚ï¸ \n*Issue Title:* <'"$ISSUE_URL"'|'"$ISSUE_TITLE"'>",
              "icon_emoji": ":test_tube:"
            }' $SLACK_WEBHOOK_URL
          else
            echo "æœªçŸ¥ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: $STATUS"
          fi
